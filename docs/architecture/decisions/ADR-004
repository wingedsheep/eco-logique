# ADR-004: Mappers in Persistence Layer

**Status**: Accepted

**Date**: 2024-11-02

---

## Decision

Database entities and their mappers stay in the `persistence/` package marked `internal`. Entities **never leak** outside this package. Repository interfaces return domain types only.

---

## Rationale

Database entities are implementation details. Keeping them internal allows us to:
- Change persistence technology without affecting domain
- Keep domain models clean of persistence annotations
- Enforce separation between domain and infrastructure layers

---

## Structure

```
products/
├── persistence/
│   ├── ProductRepository.kt        # Returns domain types
│   ├── ProductRepositoryImpl.kt    # Uses mappers internally
│   ├── ProductRepositoryJdbc.kt    # Spring Data (internal)
│   ├── ProductEntity.kt            # Entity (internal)
│   └── ProductEntityMappers.kt     # Entity ↔ Domain (internal)
└── model/
    └── Product.kt                  # Domain model (public)
```

---

## Implementation

### Entity (internal)
```kotlin
@Table("products", schema = "products")
internal data class ProductEntity(
    @Id val id: String,
    val name: String,
    val priceAmount: BigDecimal,
    val priceCurrency: String
)
```

### Mappers (internal extension functions)
```kotlin
// ProductEntityMappers.kt
internal fun ProductEntity.toProduct(): Product = Product(
    id = ProductId(this.id),
    name = this.name,
    price = Money(this.priceAmount, Currency.valueOf(this.priceCurrency))
)

internal fun Product.toProductEntity(): ProductEntity = ProductEntity(
    id = this.id.value,
    name = this.name,
    priceAmount = this.price.amount,
    priceCurrency = this.price.currency.name
)
```

### Repository (returns domain types)
```kotlin
interface ProductRepository {
    fun save(product: Product): Product
    fun findById(id: ProductId): Product?
}

@Component
internal class ProductRepositoryImpl(
    private val jdbc: ProductRepositoryJdbc
) : ProductRepository {
    override fun save(product: Product): Product {
        return jdbc.save(product.toProductEntity()).toProduct()
    }

    override fun findById(id: ProductId): Product? {
        return jdbc.findById(id.value)
            .map { it.toProduct() }
            .orElse(null)
    }
}
```

---

## Naming Convention

- **Files**: `<Type>EntityMappers.kt`
- **Functions**: `ProductEntity.toProduct()`, `Product.toProductEntity()`

---

## Consequences

### Positive
- Domain models independent of persistence technology
- Easy to swap persistence implementation
- Entities cannot leak through APIs
- Clear separation of concerns

### Negative
- Additional mapping layer
- Slight performance overhead (usually negligible)
