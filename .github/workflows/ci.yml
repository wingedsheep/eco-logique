name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: deployables/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Validate Module Dependencies
        run: ./gradlew validateModuleDependencies

      - name: Publish Module Validation Report
        if: always()
        run: |
          REPORT_FILE="build/reports/module-validation/report.md"
          if [ -f "$REPORT_FILE" ]; then
            cat "$REPORT_FILE" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Build
        run: ./gradlew build -x test

      - name: Cache build output
        uses: actions/cache/save@v4
        with:
          path: |
            deployables/backend/build
            deployables/backend/**/build
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: build-${{ github.sha }}

  test:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - name: common
            tasks: ":common:common-country:test :common:common-money:test :common:common-time:test :common:common-result:test"
          - name: products
            tasks: ":products:products-api:test :products:products-impl:test :products:products-worldview:test"
          - name: users
            tasks: ":users:users-api:test :users:users-impl:test :users:users-worldview:test"
          - name: orders
            tasks: ":orders:orders-api:test :orders:orders-impl:test :orders:orders-worldview:test"
          - name: cart
            tasks: ":cart:cart-api:test :cart:cart-impl:test :cart:cart-worldview:test"
          - name: email
            tasks: ":email:email-api:test :email:email-impl:test"
          - name: payment
            tasks: ":payment:payment-api:test :payment:payment-impl:test :payment:payment-worldview:test"
          - name: inventory
            tasks: ":inventory:inventory-api:test :inventory:inventory-impl:test :inventory:inventory-worldview:test"
          - name: checkout
            tasks: ":checkout:checkout-api:test :checkout:checkout-impl:test"

    defaults:
      run:
        working-directory: deployables/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Restore build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            deployables/backend/build
            deployables/backend/**/build
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: build-${{ github.sha }}

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run ${{ matrix.module.name }} tests
        run: ./gradlew ${{ matrix.module.tasks }} jacocoTestReport

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.module.name }}
          path: deployables/backend/**/build/test-results/test/*.xml
          retention-days: 7

      - name: Upload JaCoCo exec files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-exec-${{ matrix.module.name }}
          path: deployables/backend/**/build/jacoco/test.exec
          retention-days: 1

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.module.name }}
          path: deployables/backend/**/build/reports/tests/
          retention-days: 7

  test-application:
    needs: build
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: deployables/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Restore build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            deployables/backend/build
            deployables/backend/**/build
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: build-${{ github.sha }}

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run application E2E tests
        run: ./gradlew :application:test
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-application
          path: deployables/backend/application/build/test-results/test/*.xml
          retention-days: 7

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-application
          path: deployables/backend/application/build/reports/tests/
          retention-days: 7

  aggregate:
    needs: [test, test-application]
    if: always()
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: deployables/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Restore build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            deployables/backend/build
            deployables/backend/**/build
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: build-${{ github.sha }}

      - name: Download all JaCoCo exec files
        uses: actions/download-artifact@v4
        with:
          pattern: jacoco-exec-*
          path: deployables/backend/jacoco-artifacts
          merge-multiple: true

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: deployables/backend/test-results-artifacts
          merge-multiple: true

      - name: Restore JaCoCo exec files to build directories
        run: |
          for exec_file in $(find jacoco-artifacts -name "test.exec" 2>/dev/null); do
            # Extract module path from the artifact structure
            relative_path=$(echo "$exec_file" | sed 's|jacoco-artifacts/||')
            target_dir=$(dirname "$relative_path")
            mkdir -p "$target_dir"
            cp "$exec_file" "$relative_path"
          done

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Generate aggregated coverage report
        run: ./gradlew jacocoAggregatedReport

      - name: Publish test report
        uses: dorny/test-reporter@v1
        with:
          name: Tests
          reporter: java-junit
          path: "deployables/backend/test-results-artifacts/**/*.xml"
          fail-on-error: "false"

      - name: Add coverage to PR
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: deployables/backend/build/reports/jacoco/aggregated.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 60
          min-coverage-changed-files: 80
          title: Code Coverage (Module Tests)
          update-comment: true

      - name: Publish coverage summary
        run: |
          echo "## ðŸ“Š Code Coverage (Module Tests)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "_Excludes application-level E2E tests_" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f "build/reports/jacoco/aggregated.xml" ]; then
            INSTRUCTION_MISSED=$(grep -oP 'type="INSTRUCTION"[^/]*missed="\K[0-9]+' build/reports/jacoco/aggregated.xml | head -1 || echo "0")
            INSTRUCTION_COVERED=$(grep -oP 'type="INSTRUCTION"[^/]*covered="\K[0-9]+' build/reports/jacoco/aggregated.xml | head -1 || echo "0")

            if [ "$((INSTRUCTION_MISSED + INSTRUCTION_COVERED))" -gt 0 ]; then
              COVERAGE=$((100 * INSTRUCTION_COVERED / (INSTRUCTION_MISSED + INSTRUCTION_COVERED)))
              echo "**Overall Coverage: ${COVERAGE}%**" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "No coverage data available" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "Coverage report not found" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: deployables/backend/build/reports/jacoco/aggregated-html/
          retention-days: 7