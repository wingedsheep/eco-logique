name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: deployables/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Validate Module Dependencies
        run: ./gradlew validateModuleDependencies

      - name: Publish Module Validation Report
        if: always()
        run: |
          REPORT_FILE="build/reports/module-validation/report.md"
          if [ -f "$REPORT_FILE" ]; then
            cat "$REPORT_FILE" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Build
        run: ./gradlew build -x test

      - name: Run module tests with coverage
        run: ./gradlew test -x :application:test jacocoTestReport

      - name: Generate aggregated coverage report
        run: ./gradlew jacocoAggregatedReport

      - name: Run application tests
        run: ./gradlew :application:test

      - name: Publish module test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Module Tests
          reporter: java-junit
          path: |
            deployables/backend/**/build/test-results/test/*.xml
            !deployables/backend/application/build/test-results/test/*.xml
          fail-on-error: "false"

      - name: Publish application test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Application Tests (E2E)
          reporter: java-junit
          path: deployables/backend/application/build/test-results/test/*.xml
          fail-on-error: "false"

      - name: Add coverage to PR
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: deployables/backend/build/reports/jacoco/aggregated.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 60
          min-coverage-changed-files: 80
          title: Code Coverage (Module Tests)
          update-comment: true

      - name: Publish coverage summary
        if: always()
        run: |
          echo "## ðŸ“Š Code Coverage (Module Tests)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "_Excludes application-level E2E tests_" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          if [ -f "build/reports/jacoco/aggregated.xml" ]; then
            INSTRUCTION_MISSED=$(grep -oP 'type="INSTRUCTION"[^/]*missed="\K[0-9]+' build/reports/jacoco/aggregated.xml | head -1 || echo "0")
            INSTRUCTION_COVERED=$(grep -oP 'type="INSTRUCTION"[^/]*covered="\K[0-9]+' build/reports/jacoco/aggregated.xml | head -1 || echo "0")
          
            if [ "$((INSTRUCTION_MISSED + INSTRUCTION_COVERED))" -gt 0 ]; then
              COVERAGE=$((100 * INSTRUCTION_COVERED / (INSTRUCTION_MISSED + INSTRUCTION_COVERED)))
              echo "**Overall Coverage: ${COVERAGE}%**" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "No coverage data available" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "Coverage report not found" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: deployables/backend/build/reports/jacoco/aggregated-html/
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: 'deployables/backend/**/build/reports/tests/'
          retention-days: 7
